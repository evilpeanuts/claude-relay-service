# Workflow çš„åç§°ï¼Œä¼šæ˜¾ç¤ºåœ¨ GitHub Actions é¡µé¢
name: ğŸ”„ Sync Upstream (Rebase Clean)

# å®šä¹‰ä½•æ—¶è§¦å‘è¿™ä¸ª workflow
on:
  schedule:
    # æ¯å¤© UTC 2:00 è¿è¡Œ = åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 10:00
    - cron: "0 2 * * *"
  
  # å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘
  workflow_dispatch:

# æƒé™è®¾ç½®ï¼šç»™äºˆè¿™ä¸ª workflow å†™å…¥ä»“åº“å†…å®¹çš„æƒé™
#permissions:
#  contents: write  # å…è®¸æ¨é€ä»£ç åˆ°ä»“åº“

# å®šä¹‰è¦æ‰§è¡Œçš„ä»»åŠ¡
jobs:
  # ä»»åŠ¡åç§°ä¸º "sync"
  sync:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒï¼šä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu Linux
    runs-on: ubuntu-latest

    # å®šä¹‰è¿™ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ­¥éª¤
    steps:
      # ========== æ­¥éª¤ 1ï¼šæ£€å‡ºä½ çš„ä»“åº“ä»£ç  ==========
      - name: ğŸ§© Checkout your repository
        # ä½¿ç”¨ GitHub å®˜æ–¹æä¾›çš„ checkout action
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ ${{ secrets.GITHUB_TOKEN }} è¿›è¡Œè®¤è¯ï¼Œ å¦‚æœæƒé™ä¸è¶³ ä½¿ç”¨ ${{ secrets.SYNC_TOKEN }} åŒæ—¶åˆ é™¤ permissions: contents: write 
          token: ${{ secrets.SYNC_TOKEN }}
          
          # è·å–å®Œæ•´çš„ Git å†å²è®°å½•
          fetch-depth: 0

      # ========== æ­¥éª¤ 2ï¼šé…ç½® Git ç”¨æˆ·ä¿¡æ¯ ==========
      - name: ğŸ§± Configure Git
        run: |
          # è®¾ç½® Git æäº¤æ—¶ä½¿ç”¨çš„ç”¨æˆ·å
          git config user.name "github-actions[bot]"
          
          # è®¾ç½® Git æäº¤æ—¶ä½¿ç”¨çš„é‚®ç®±
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # ========== æ­¥éª¤ 3ï¼šæ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶è·å–æœ€æ–°ä»£ç  ==========
      - name: ğŸ”— Add upstream remote
        run: |
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“ï¼ˆä½¿ç”¨ HTTPS åœ°å€ï¼Œè€Œä¸æ˜¯ SSHï¼‰
          git remote add upstream https://github.com/Wei-Shaw/claude-relay-service.git
          
          # ä»ä¸Šæ¸¸ä»“åº“è·å–æ‰€æœ‰åˆ†æ”¯å’Œæäº¤è®°å½•
          git fetch upstream

      # ========== æ­¥éª¤ 4ï¼šä½¿ç”¨ rebase æ–¹å¼åŒæ­¥ä¸»åˆ†æ”¯ ==========
      - name: ğŸ”„ Rebase main with upstream/main
        run: |
          # åˆ‡æ¢åˆ° main åˆ†æ”¯
          git checkout main
          
          # è¾“å‡ºæç¤ºä¿¡æ¯
          echo "Fetching and rebasing from upstream/main..."
          
          # æ‰§è¡Œ rebase æ“ä½œ
          # æ—¶è‡ªåŠ¨æŠŠå†²çªæ–‡ä»¶å…¨éƒ¨ç”¨ theirs å¹¶ç»§ç»­ï¼ˆä¸ä¸­æ–­ workflowï¼‰
          git rebase upstream/main  -X theirs || (
            echo "âš ï¸ Rebase conflict, aborting."
            git rebase --abort
            exit 0
          )

      # ========== æ­¥éª¤ 5ï¼šå¼ºåˆ¶æ¨é€æ›´æ–°åçš„ main åˆ†æ”¯ ==========
      - name: ğŸš€ Push rebased main back to origin
        run: |
          # æ¨é€ main åˆ†æ”¯åˆ°è¿œç¨‹ä»“åº“
          # --force-with-leaseï¼šå®‰å…¨çš„å¼ºåˆ¶æ¨é€
          git push origin main --force-with-lease

      # ========== æ­¥éª¤ 5.5ï¼šåŒæ­¥æœ€æ–°çš„ 50 æ¡ tags ==========
      - name: ğŸ·ï¸ Sync latest 50 tags from upstream
        if: ${{ success() }}
        run: |
          # è¾“å‡ºæç¤ºä¿¡æ¯
          echo "Syncing latest 50 tags from upstream..."

          # ä»ä¸Šæ¸¸è·å–æ‰€æœ‰ tags
          git fetch upstream --tags

          # è·å–æœ€æ–°çš„ 50 æ¡ tagsï¼ˆæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼‰
          latest_tags=$(git tag --sort=-creatordate | head -n 50)

          # æ£€æŸ¥æ˜¯å¦æœ‰ tags
          if [ -z "$latest_tags" ]; then
            echo "â„¹ï¸ No tags found in upstream repository"
            exit 0
          fi

          # è¾“å‡ºæ‰¾åˆ°çš„ tags æ•°é‡
          tag_count=$(echo "$latest_tags" | wc -l)
          echo "ğŸ“Œ Found $tag_count tags to sync"

          # æ¨é€è¿™äº› tags åˆ° originï¼ˆå¼ºåˆ¶è¦†ç›–ï¼‰
          # ä½¿ç”¨ --force æ˜¯å› ä¸ºä¸Šæ¸¸å¯èƒ½ä¼šä¿®æ”¹å·²å­˜åœ¨çš„ tag
          echo "$latest_tags" | while read -r tag; do
            if [ -n "$tag" ]; then
              echo "  Pushing tag: $tag"
              git push origin "$tag" --force || echo "  âš ï¸ Failed to push tag: $tag"
            fi
          done

          echo "âœ… Tags sync completed"

      # ========== æ­¥éª¤ 6ï¼šæ›´æ–°ä½ çš„ CustomProduction å¼€å‘åˆ†æ”¯ ==========
      - name: ğŸ§¬ Update CustomProduction branch from main
        # åªæœ‰å½“å‰é¢æ‰€æœ‰æ­¥éª¤éƒ½æˆåŠŸæ—¶æ‰æ‰§è¡Œ
        if: ${{ success() }}
        run: |
          # å°è¯•ä»è¿œç¨‹è·å– CustomProduction åˆ†æ”¯
          # å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºå®ƒ
          git fetch origin CustomProduction || git branch CustomProduction
          
          # åˆ‡æ¢åˆ° CustomProduction åˆ†æ”¯
          git checkout CustomProduction
          
          # å°† CustomProduction åˆ†æ”¯ rebase åˆ°æœ€æ–°çš„ main åˆ†æ”¯ä¸Š
          # è¿™æ ·ä½ çš„è‡ªå®šä¹‰åŠŸèƒ½ä¼šå»ºç«‹åœ¨æœ€æ–°çš„ä¸Šæ¸¸ä»£ç ä¹‹ä¸Š
          git rebase upstream/main -X theirs || (
            echo "âš ï¸ Conflict detected on CustomProduction, skipping."
            git rebase --abort
            exit 0
          )
          
          # æ¨é€æ›´æ–°åçš„ CustomProduction åˆ†æ”¯
          git push origin CustomProduction --force-with-lease

      # ========== æ­¥éª¤ 7ï¼šè¾“å‡ºåŒæ­¥æ‘˜è¦ ==========
      - name: ğŸ“Š Sync summary
        if: ${{ success() }}
        run: |
          echo "âœ… Successfully synced with upstream repository"
          echo "ğŸ“Š Latest commits from upstream:"
          git log --oneline -5 upstream/main